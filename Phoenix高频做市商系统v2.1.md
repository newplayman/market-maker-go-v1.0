# Project Phoenix: é«˜é¢‘ USDC æ°¸ç»­åˆçº¦åšå¸‚ç³»ç»Ÿ

**ç‰ˆæœ¬**: v2.1 (Phoenix Production Release, 2025-11-30)  
**ä½œè€…/æ¶æ„å¸ˆ**: Grok (xAI é«˜é¢‘é‡åŒ–å·¥ç¨‹å¸ˆ) + AI Assistant  
**çŠ¶æ€**: ç”Ÿäº§çº§ç³»ç»Ÿ - å®ç›˜éªŒè¯ç‰ˆæœ¬  
**è®¸å¯è¯**: Apache 2.0

---

## ğŸ“‹ æ–‡æ¡£å£°æ˜

è¿™ä»½æ–‡æ¡£æ˜¯ Project Phoenix v2.1 çš„å®Œæ•´æŠ€æœ¯è§„èŒƒï¼ŒåŸºäº v2.0 çš„ç”Ÿäº§å®ç›˜æµ‹è¯•å’Œå¤šè½®ä¼˜åŒ–è¿­ä»£ã€‚ä½œä¸ºé¡¹ç›®çš„"å®ªæ³•"ï¼Œå®ƒè¯¦ç»†è®°å½•äº†ç»è¿‡å®æˆ˜éªŒè¯çš„ç­–ç•¥ã€é£æ§ã€è®¢å•ç®¡ç†å’Œç›‘æ§æœºåˆ¶ã€‚

### ç‰ˆæœ¬æ›´æ–°å†å²

- **v1.0 (2025-11-27)**: åˆå§‹Phoenixé‡æ„è“å›¾
- **v2.0 (2025-11-28)**: é¦–æ¬¡ç”Ÿäº§éƒ¨ç½²ç‰ˆæœ¬
- **v2.1 (2025-11-30)**: å®ç›˜ä¼˜åŒ–ç‰ˆæœ¬
  - âœ… ç»Ÿä¸€å‡ ä½•ç½‘æ ¼ç®—æ³•ï¼ˆ36å±‚è®¢å•ï¼‰
  - âœ… æ‰¹é‡é£æ§é¢„æ£€æœºåˆ¶
  - âœ… é˜²é—ªçƒå®¹å·®ä¼˜åŒ–ï¼ˆæ’¤å•<50/minï¼‰
  - âœ… æŒä»“è‡ªé€‚åº”æŠ¥ä»·ï¼ˆè½»ä»“åšå¸‚åŸåˆ™ï¼‰
  - âœ… å‡æ­»é—®é¢˜ä¿®å¤ï¼ˆæ’¤å•è®¡æ•°å™¨é‡ç½®ï¼‰
  - âœ… é…ç½®çƒ­é‡è½½ä¿®å¤

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **è½»ä»“åšå¸‚**: å‡€ä»“ä½ä¸¥æ ¼æ§åˆ¶åœ¨ NetMax ä»¥å†…ï¼Œé€šè¿‡åŠ¨æ€è°ƒæ•´è®¢å•æ•°é‡å®ç°
2. **é˜²é—ªçƒæœºåˆ¶**: æ™ºèƒ½å®¹å·®é¿å…ä¸å¿…è¦çš„æ’¤å•é‡æŒ‚ï¼Œæ’¤å•ç‡ <50/min
3. **æ‰¹é‡é£æ§**: ä¸‹å•å‰è¯„ä¼°æ‰€æœ‰è®¢å•çš„ç´¯è®¡é£é™©ï¼Œè€Œéå•ä¸ªè®¢å•
4. **æŒä»“è‡ªé€‚åº”**: æ ¹æ®å½“å‰ä»“ä½åŠ¨æ€è°ƒæ•´ä¹°/å–å•æ•°é‡å’Œä»·æ ¼åç§»
5. **ç»Ÿä¸€ç½‘æ ¼**: ä½¿ç”¨å‡ ä½•çº§æ•°è®¡ç®—è®¢å•åˆ†å¸ƒï¼Œç²¾ç¡®æ§åˆ¶ä»·æ ¼æ¢¯åº¦

---

## ä¸€ã€é¡¹ç›®ç›®æ ‡

### 1.1 ä¸šåŠ¡ç›®æ ‡

- **æ ¸å¿ƒåŠŸèƒ½**: åœ¨ Binance USDC-margined æ°¸ç»­åˆçº¦ï¼ˆå… maker è´¹å¯¹ï¼Œå¦‚ ETHUSDCï¼‰ä¸Šè¿è¡Œé«˜é¢‘åšå¸‚ï¼Œæä¾›åŒè¾¹æµåŠ¨æ€§
- **å…³é”®æŒ‡æ ‡**:
  - æ”¶ç›Šç‡: å¹´åŒ– 100%+ï¼ˆå°èµ„é‡‘ 200-5k USDC: 200-400%ï¼‰
  - é£é™©æ§åˆ¶: æœ€å¤§å›æ’¤ <25%ï¼›å‡€ä»“ç¡¬å¸½ per-symbol 0.30 ETHï¼ˆå®æµ‹ä¼˜åŒ–å€¼ï¼‰
  - è¿è¥æ•ˆç‡: æŠ¥ä»·é—´éš” 1000msï¼›**æ’¤å•ç‡ <50/min**ï¼›fill rate >35%
  - è®¢å•åˆ†å¸ƒ: å•è¾¹18å±‚ï¼ˆæ€»36å±‚ï¼‰ï¼Œbuy1/sell1 è·ç¦» mid 1.2Uï¼Œä»·å·® 2.4U

### 1.2 æŠ€æœ¯ç›®æ ‡

- **å¯é æ€§**: 99.9% uptimeï¼›WSS å…¨é“¾è·¯ï¼›è‡ªåŠ¨æ¢å¤ï¼ˆæ’¤å•è®¡æ•°å™¨æ¯åˆ†é’Ÿé‡ç½®ï¼‰
- **å¯æ‰©å±•æ€§**: æ’ä»¶å¼ symbol é…ç½®ï¼›æ˜“åŠ æ–°ç­–ç•¥
- **å¯è§‚æµ‹æ€§**: Prometheus/Grafana å…¨æŒ‡æ ‡ï¼›è¯¦ç»†æ—¥å¿—ï¼ˆå‡ ä½•ç½‘æ ¼å‚æ•°ã€é˜²é—ªçƒå®¹å·®ï¼‰
- **å®‰å…¨æ€§**: API key ç¯å¢ƒå˜é‡ï¼›é™é¢‘è‡ªé€‚åº”

### 1.3 æˆåŠŸæ ‡å‡†

- âœ… 72h è¿ç»­å®ç›˜: æ— çˆ†ä»“ã€**æ’¤å• <50/min**ã€fill rate >35%
- âœ… è®¢å•ç²¾åº¦: buy1/sell1 è·ç¦» mid 1-1.5Uï¼Œä»·å·® 2.4-3.0U
- âœ… æŒä»“æ§åˆ¶: 36å±‚è®¢å•å®Œå…¨æŒ‚å‡ºï¼Œæ‰¹é‡é£æ§é€šè¿‡
- âœ… é˜²å‡æ­»: ç³»ç»Ÿåœ¨é«˜æ’¤å•åè‡ªåŠ¨æ¢å¤ï¼Œæ— æ°¸ä¹…åœæ­¢

---

## äºŒã€æ¶æ„ä¸ä»£ç æ¡†æ¶

### 2.1 ç›®å½•ç»“æ„

```text
market-maker-go/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ phoenix/              # ä¸»ç¨‹åºå…¥å£
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â””â”€â”€ emergency/            # ç´§æ€¥æ¸…ä»“å·¥å…·
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/               # é…ç½®ç®¡ç†ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
â”‚   â”‚   â””â”€â”€ config.go
â”‚   â”œâ”€â”€ exchange/             # Binance APIå°è£…
â”‚   â”‚   â”œâ”€â”€ binance_ws.go     # WebSocketæµ
â”‚   â”‚   â””â”€â”€ binance_rest.go   # RESTæ¥å£
â”‚   â”œâ”€â”€ store/                # çŠ¶æ€å­˜å‚¨ï¼ˆå†…å­˜+å¿«ç…§ï¼‰
â”‚   â”‚   â””â”€â”€ store.go
â”‚   â”œâ”€â”€ strategy/             # ASMMç­–ç•¥æ ¸å¿ƒ
â”‚   â”‚   â””â”€â”€ strategy.go       # ç»Ÿä¸€å‡ ä½•ç½‘æ ¼ç®—æ³•
â”‚   â”œâ”€â”€ risk/                 # é£æ§æ¨¡å—
â”‚   â”‚   â””â”€â”€ risk.go           # æ‰¹é‡é¢„æ£€+æ­¢æŸ
â”‚   â”œâ”€â”€ order/                # è®¢å•ç®¡ç†
â”‚   â”‚   â””â”€â”€ manager.go        # è®¢å•å·®åˆ†+é˜²é—ªçƒ
â”‚   â”œâ”€â”€ runner/               # ä¸»å¾ªç¯åè°ƒ
â”‚   â”‚   â””â”€â”€ runner.go         # æŠ¥ä»·ç”Ÿæˆ+æ‰§è¡Œ
â”‚   â””â”€â”€ metrics/              # Prometheusç›‘æ§
â”‚       â””â”€â”€ prometheus.go
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ phoenix_live.yaml     # ç”Ÿäº§é…ç½®ï¼ˆv2.1ä¼˜åŒ–ï¼‰
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ start.sh              # å¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ stop.sh               # åœæ­¢è„šæœ¬
â”‚   â””â”€â”€ emergency_stop.sh     # ç´§æ€¥æ¸…ä»“
â”œâ”€â”€ docs/                     # æŠ€æœ¯æ–‡æ¡£
â”‚   â”œâ”€â”€ Phoenixé«˜é¢‘åšå¸‚å•†ç³»ç»Ÿv2.1.md    # æœ¬æ–‡æ¡£
â”‚   â”œâ”€â”€ CHANGELOG.md          # å˜æ›´æ—¥å¿—
â”‚   â””â”€â”€ ANTI_FLICKER_FIX.md   # é˜²é—ªçƒä¼˜åŒ–æ–‡æ¡£
â”œâ”€â”€ go.mod
â””â”€â”€ Dockerfile
```

### 2.2 æ•°æ®æµ

```text
WSSæ·±åº¦æµ â†’ Store(æ›´æ–°MidPrice) 
          â†“
Strategy(ç”Ÿæˆ36å±‚å‡ ä½•ç½‘æ ¼æŠ¥ä»·) 
          â†“
Risk(æ‰¹é‡é£æ§é¢„æ£€) â†’ åŠ¨æ€è°ƒæ•´æŠ¥ä»·æ•°é‡
          â†“
OrderManager(è®¢å•å·®åˆ†+é˜²é—ªçƒ) â†’ è®¡ç®—éœ€è¦æ’¤é”€/æ–°å¢çš„è®¢å•
          â†“
Exchange(æ‰¹é‡ä¸‹å•/æ’¤å•) â†’ Binance API
          â†“
Metrics(ä¸ŠæŠ¥ç›‘æ§æŒ‡æ ‡) â†’ Prometheus â†’ Grafana
```

---

## ä¸‰ã€æ ¸å¿ƒæ¨¡å—è¯¦è¿°

### 3.1 é…ç½®ç®¡ç† (internal/config/)

#### å…³é”®é…ç½®å‚æ•°ï¼ˆv2.1ä¼˜åŒ–ï¼‰

```yaml
global:
  total_notional_max: 180.0    # æ€»åä¹‰ä»·å€¼ä¸Šé™ï¼ˆ190 USDCæµ‹è¯•èµ„é‡‘ï¼‰
  quote_interval_ms: 1000      # æŠ¥ä»·é—´éš”1ç§’ï¼ˆé™ä½æ’¤å•é¢‘ç‡ï¼‰

symbols:
  - symbol: "ETHUSDC"
    # ä»“ä½é™åˆ¶
    net_max: 0.30              # æœ€å¤§å‡€ä»“ä½0.30 ETHï¼ˆæ”¯æŒ36å±‚è®¢å•ï¼‰
    
    # ç»Ÿä¸€å‡ ä½•ç½‘æ ¼é…ç½®ï¼ˆv2.1æ–°å¢ï¼‰
    total_layers: 18           # å•è¾¹å±‚æ•°18ï¼ˆå…±36å±‚ï¼‰
    unified_layer_size: 0.007  # ç»Ÿä¸€å±‚å¤§å°0.007 ETH
    grid_start_offset: 1.2     # ç¬¬1å±‚è·ç¦»mid 1.2 USDT
    grid_first_spacing: 1.2    # ç¬¬1-2å±‚é—´è· 1.2 USDT
    grid_spacing_multiplier: 1.15  # å‡ ä½•ç³»æ•°1.15
    grid_max_spacing: 25.0     # æœ€å¤§å±‚é—´è·25 USDT
    
    # ç²¾åº¦é…ç½®
    tick_size: 0.01            # ä»·æ ¼æœ€å°å˜åŠ¨ $0.01
    min_qty: 0.001             # æœ€å°ä¸‹å•é‡ 0.001 ETH
    min_spread: 0.0007         # æœ€å°ä»·å·® 0.07%
    
    # æ¨¡å¼åˆ‡æ¢é˜ˆå€¼
    pinning_enabled: true
    pinning_thresh: 0.5        # 50% NetMaxè§¦å‘Pinning
    grinding_enabled: true
    grinding_thresh: 0.7       # 70% NetMaxè§¦å‘Grinding
    
    # é£æ§å‚æ•°
    max_cancel_per_min: 50     # æœ€å¤§æ’¤å•é¢‘ç‡ï¼ˆå…³é”®æŒ‡æ ‡ï¼‰
    stop_loss_thresh: 0.05     # æ­¢æŸé˜ˆå€¼5%
    inventory_skew_coeff: 0.002  # åº“å­˜åç§»ç³»æ•°
```

#### é…ç½®éªŒè¯è§„åˆ™

```go
// éªŒè¯å‡ ä½•ç½‘æ ¼å‚æ•°
if sym.GridStartOffset <= 0 {
    return fmt.Errorf("grid_start_offset å¿…é¡» > 0")
}
if sym.GridSpacingMultiplier <= 1.0 {
    return fmt.Errorf("grid_spacing_multiplier å¿…é¡» > 1.0")
}

// éªŒè¯æ¨¡å¼åˆ‡æ¢é¡ºåº
if sym.PinningThresh >= sym.GrindingThresh {
    return fmt.Errorf("pinning_thresh å¿…é¡» < grinding_thresh")
}
```

#### çƒ­é‡è½½æœºåˆ¶

- ä½¿ç”¨ `fsnotify` ç›‘æ§é…ç½®æ–‡ä»¶å˜æ›´
- éªŒè¯æ–°é…ç½®ååŸå­æ›¿æ¢
- **ä¿®å¤**: ä½¿ç”¨æŒ‡é’ˆä¿®æ”¹ `cfg.Symbols[i]` ç¡®ä¿é…ç½®ç”Ÿæ•ˆ

```go
// ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰ï¼š
for i, sym := range cfg.Symbols {
    sym.TotalLayers = ...  // ä¿®æ”¹çš„æ˜¯å‰¯æœ¬ï¼Œä¸ç”Ÿæ•ˆ
}

// ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰ï¼š
for i := range cfg.Symbols {
    sym := &cfg.Symbols[i]  // ä½¿ç”¨æŒ‡é’ˆ
    sym.TotalLayers = ...
    cfg.Symbols[i] = *sym   // æ˜¾å¼èµ‹å€¼å›å»
}
```

---

### 3.2 ç­–ç•¥æ ¸å¿ƒ (internal/strategy/)

#### ASMM (Adaptive Skewed Market Making) v2.1

**æ ¸å¿ƒç®—æ³•: ç»Ÿä¸€å‡ ä½•ç½‘æ ¼**

```go
// è®¡ç®—ç¬¬nå±‚è·ç¦»midçš„æ€»è·ç¦»ï¼ˆUSDTï¼‰
func calculateLayerDistance(n int, cfg *config.SymbolConfig) float64 {
    if n == 0 {
        // ç¬¬1å±‚ï¼šä»…åˆå§‹åç§»
        return cfg.GridStartOffset
    }
    
    // ç¬¬2å±‚åŠä»¥åï¼šåˆå§‹åç§» + ç´¯è®¡å±‚é—´è·
    distance := cfg.GridStartOffset
    for j := 0; j < n; j++ {
        spacing := cfg.GridFirstSpacing * math.Pow(cfg.GridSpacingMultiplier, float64(j))
        
        // é™åˆ¶æœ€å¤§å±‚é—´è·
        if cfg.GridMaxSpacing > 0 && spacing > cfg.GridMaxSpacing {
            spacing = cfg.GridMaxSpacing
        }
        
        distance += spacing
    }
    
    return distance
}
```

**å‡ ä½•çº§æ•°ç‰¹æ€§**:
- ç¬¬1å±‚: è·mid 1.2U
- ç¬¬2å±‚: è·mid 2.4Uï¼ˆ1.2 + 1.2ï¼‰
- ç¬¬3å±‚: è·mid 3.78Uï¼ˆ1.2 + 1.2 + 1.38ï¼‰
- ...
- ç¬¬18å±‚: è·mid ~80Uï¼ˆæœ€åå‡ å±‚é—´è·æ¥è¿‘25Uä¸Šé™ï¼‰

**æŒä»“è‡ªé€‚åº”é€»è¾‘ï¼ˆv2.1å…³é”®ä¿®å¤ï¼‰**:

```go
// æ ¹æ®å½“å‰ä»“ä½è°ƒæ•´å±‚æ•°
currentPos := state.Position.Size
posRatio := math.Abs(currentPos) / cfg.NetMax

buyLayerCount := cfg.TotalLayers
sellLayerCount := cfg.TotalLayers

if currentPos > 0 {
    // å¤šå¤´ä»“ä½ï¼šå‡å°‘ä¹°å•å±‚æ•°ï¼Œä¿æŒå–å•å±‚æ•°ï¼ˆä»¥ä¾¿å¹³ä»“è·åˆ©ï¼‰
    buyLayerCount = int(float64(cfg.TotalLayers) * (1.0 - posRatio*0.6))
    if buyLayerCount < 1 {
        buyLayerCount = 1
    }
    sellLayerCount = cfg.TotalLayers  // å…³é”®ï¼šä¿æŒå–å•å±‚æ•°
} else if currentPos < 0 {
    // ç©ºå¤´ä»“ä½ï¼šå‡å°‘å–å•å±‚æ•°ï¼Œä¿æŒä¹°å•å±‚æ•°
    sellLayerCount = int(float64(cfg.TotalLayers) * (1.0 - posRatio*0.6))
    if sellLayerCount < 1 {
        sellLayerCount = 1
    }
    buyLayerCount = cfg.TotalLayers  // å…³é”®ï¼šä¿æŒä¹°å•å±‚æ•°
}
```

**Inventory Skewï¼ˆåº“å­˜åç§»ï¼‰**:

```go
func calculateInventorySkew(pos, netMax, mid float64, cfg *config.SymbolConfig) float64 {
    targetRatio := pos / netMax  // [-1, 1]
    
    // æ­»åŒºé€»è¾‘ï¼šå˜åŒ–<5%æ—¶ä¿æŒä¸Šæ¬¡å€¼ï¼ˆé˜²é—ªçƒï¼‰
    if exists && math.Abs(currentRatio - lastRatio) < 0.05 {
        targetRatio = lastRatio
    }
    
    skewCoeff := cfg.InventorySkewCoeff  // é»˜è®¤0.002
    return -targetRatio * skewCoeff * mid
}

// ä¾‹ï¼šæŒä»“0.021 ETHï¼ŒNetMax 0.30 ETHï¼Œmid 3000
// inventorySkew = -(0.021/0.30) Ã— 0.002 Ã— 3000 = -0.42 USDT
// reservation = 3000 - 0.42 = 2999.58 USDTï¼ˆå‘ä¸‹åç§»ï¼Œé¼“åŠ±å–å‡ºï¼‰
```

#### Pinningæ¨¡å¼ï¼ˆé˜²é—ªçƒé’‰å­æ¨¡å¼ï¼‰

**è§¦å‘æ¡ä»¶**: `|pos| / NetMax > pinning_thresh (0.5)`

**ç­–ç•¥**:
- å¤šå¤´: å–å•é’‰åœ¨ bestAskï¼Œä¹°å•ä¿æŒè¿œç«¯å±‚
- ç©ºå¤´: ä¹°å•é’‰åœ¨ bestBidï¼Œå–å•ä¿æŒè¿œç«¯å±‚

**å·²çŸ¥é—®é¢˜**ï¼ˆå¾…ä¿®å¤ï¼‰:
- å¤šå¤´æ—¶ç¼ºå°‘è¿‘ç«¯ä¹°å•é˜²æŠ¤
- å¯èƒ½å¯¼è‡´ä¹°1å–1ä»·å·®è¿‡å¤§ï¼ˆ10U+ï¼‰
- **å»ºè®®**: å®ç›˜ä¸­è€ƒè™‘ç¦ç”¨ Pinningï¼Œä¾èµ– Normal æ¨¡å¼çš„æŒä»“è‡ªé€‚åº”

#### Grindingæ¨¡å¼ï¼ˆåº“å­˜ç£¨æˆæœ¬ï¼‰

**è§¦å‘æ¡ä»¶**: `|pos| / NetMax > grinding_thresh (0.7)`

**ç­–ç•¥**:
- ä¸»åŠ¨takerå¹³ä»“ï¼ˆ7.5%ä»“ä½ï¼‰
- Makeré‡æ–°è¿›åœºï¼ˆä»·æ ¼åç§»+4.2bpsï¼Œè®¢å•å¤§å°Ã—2.1ï¼‰

---

### 3.3 é£æ§æ¨¡å— (internal/risk/)

#### v2.1æ ¸å¿ƒåˆ›æ–°ï¼šæ‰¹é‡é£æ§é¢„æ£€

**é—®é¢˜**: ä¹‹å‰åªæ£€æŸ¥å•ä¸ªè®¢å•ï¼Œå¯¼è‡´18å±‚ä¹°å•ï¼ˆ18Ã—0.007=0.126 ETHï¼‰å¯èƒ½è¶…è¿‡é£æ§ä¸Šé™ï¼ˆ0.15 ETHï¼‰

**è§£å†³æ–¹æ¡ˆ**: åœ¨ä¸‹å•å‰è®¡ç®—æ‰€æœ‰è®¢å•çš„ç´¯è®¡é£é™©

```go
func CheckBatchPreTrade(quotes []Quote, symbol string) error {
    state := store.GetSymbolState(symbol)
    currentPos := state.Position.Size
    
    // è®¡ç®—æœ€åæƒ…å†µï¼ˆæ‰€æœ‰ä¹°å•æˆäº¤ = å¤šå¤´æ•å£ï¼‰
    var totalBuySize, totalSellSize float64
    for _, q := range quotes {
        if q.Side == "BUY" {
            totalBuySize += q.Size
        } else {
            totalSellSize += q.Size
        }
    }
    
    worstCaseLong := currentPos + totalBuySize
    worstCaseShort := currentPos - totalSellSize
    
    maxWorstCase := cfg.NetMax * 0.5  // æœ€å¤šç”¨50% NetMax
    
    // å…³é”®ä¿®å¤ï¼šåªæ£€æŸ¥"åŠ ä»“"æ–¹å‘ï¼Œä¸é™åˆ¶"å¹³ä»“"æ–¹å‘
    if currentPos >= 0 {
        // æ— ä»“ä½æˆ–å¤šå¤´ä»“ä½ï¼šåªæ£€æŸ¥å¤šå¤´æ–¹å‘é£é™©
        if math.Abs(worstCaseLong) > maxWorstCase {
            return fmt.Errorf("å¤šå¤´æ•å£è¶…é™: %.4f > %.4f", 
                math.Abs(worstCaseLong), maxWorstCase)
        }
    }
    if currentPos <= 0 {
        // æ— ä»“ä½æˆ–ç©ºå¤´ä»“ä½ï¼šåªæ£€æŸ¥ç©ºå¤´æ–¹å‘é£é™©
        if math.Abs(worstCaseShort) > maxWorstCase {
            return fmt.Errorf("ç©ºå¤´æ•å£è¶…é™: %.4f > %.4f", 
                math.Abs(worstCaseShort), maxWorstCase)
        }
    }
    
    return nil
}
```

**åŠ¨æ€è°ƒæ•´æœºåˆ¶**: å¦‚æœæ‰¹é‡é£æ§å¤±è´¥ï¼Œè‡ªåŠ¨å‡å°‘å±‚æ•°

```go
func adjustQuotesForRisk(buyQuotes, sellQuotes []Quote, symbol string) ([]Quote, []Quote) {
    maxRetries := 5
    for i := 0; i < maxRetries; i++ {
        if CheckBatchPreTrade(allQuotes, symbol) == nil {
            return buyQuotes, sellQuotes
        }
        
        // å‡å°‘10%å±‚æ•°
        reduceRatio := 0.9
        buyQuotes = buyQuotes[:int(float64(len(buyQuotes))*reduceRatio)]
        sellQuotes = sellQuotes[:int(float64(len(sellQuotes))*reduceRatio)]
    }
    
    return buyQuotes, sellQuotes
}
```

#### å•è®¢å•é£æ§

```go
func CheckPreTrade(quote Quote, symbol string) error {
    // 1. æ£€æŸ¥è®¢å•å¤§å°
    if quote.Size < cfg.MinQty {
        return ErrSizeTooSmall
    }
    
    // 2. æ£€æŸ¥ä»·æ ¼åç¦»
    deviation := math.Abs(quote.Price - state.MidPrice) / state.MidPrice
    if deviation > 0.15 {  // 15%
        return ErrPriceDeviation
    }
    
    // 3. æ£€æŸ¥å•ä¸ªè®¢å•å¯¹ä»“ä½çš„å½±å“
    newPos := currentPos
    if quote.Side == "BUY" {
        newPos += quote.Size
    } else {
        newPos -= quote.Size
    }
    
    if math.Abs(newPos) > cfg.NetMax {
        return ErrNetMaxBreach
    }
    
    return nil
}
```

#### æ­¢æŸæœºåˆ¶

```go
func CheckStopLoss(symbol string) error {
    pnl := state.Position.UnrealizedPNL
    notional := math.Abs(state.Position.Size * state.MidPrice)
    
    if notional > 0 {
        pnlRatio := pnl / notional
        if pnlRatio < -cfg.StopLossThresh {  // -5%
            log.Error().Msg("è§¦å‘æ­¢æŸ")
            return ErrStopLoss
        }
    }
    
    return nil
}
```

---

### 3.4 è®¢å•ç®¡ç† (internal/order/)

#### è®¢å•å·®åˆ†ç®—æ³•ï¼ˆé˜²é—ªçƒæ ¸å¿ƒï¼‰

**ç›®æ ‡**: åªæ’¤é”€/æ–°å¢çœŸæ­£éœ€è¦è°ƒæ•´çš„è®¢å•ï¼Œå‡å°‘ä¸å¿…è¦çš„æ’¤å•

```go
func calculateOrderDiff(desired []Quote, active []Order, cfg *config.SymbolConfig, state *store.SymbolState) (toCancel, toPlace []Quote) {
    // è®¡ç®—é˜²é—ªçƒå®¹å·®ï¼ˆv2.1ä¿®å¤ï¼‰
    layerSpacing := cfg.GridStartOffset  // ä½¿ç”¨ç¬¬ä¸€å±‚è·ç¦»ä½œä¸ºåŸºå‡†
    if layerSpacing <= 0 {
        layerSpacing = 1.2  // é»˜è®¤å€¼
    }
    tolerance := layerSpacing * 0.9  // å®¹å·®ä¸ºç¬¬ä¸€å±‚é—´è·çš„90%
    
    // æ ‡è®°éœ€è¦ä¿ç•™çš„æ´»è·ƒè®¢å•
    keep := make(map[string]bool)
    
    for _, activeOrder := range active {
        shouldKeep := false
        
        for _, desiredQuote := range desired {
            if activeOrder.Side != desiredQuote.Side {
                continue
            }
            
            priceDiff := math.Abs(activeOrder.Price - desiredQuote.Price)
            sizeDiff := math.Abs(activeOrder.Quantity - desiredQuote.Size)
            
            // åˆ¤æ–­æ˜¯å¦åœ¨å®¹å·®èŒƒå›´å†…
            if priceDiff <= tolerance && sizeDiff < cfg.MinQty*0.1 {
                shouldKeep = true
                break
            }
        }
        
        if shouldKeep {
            keep[activeOrder.ClientOrderID] = true
        } else {
            toCancel = append(toCancel, convertOrderToQuote(activeOrder))
        }
    }
    
    // è®¡ç®—éœ€è¦æ–°å¢çš„è®¢å•
    for _, desiredQuote := range desired {
        matched := false
        for _, activeOrder := range active {
            if keep[activeOrder.ClientOrderID] && 
               activeOrder.Side == desiredQuote.Side &&
               math.Abs(activeOrder.Price - desiredQuote.Price) <= tolerance {
                matched = true
                break
            }
        }
        
        if !matched {
            toPlace = append(toPlace, desiredQuote)
        }
    }
    
    return toCancel, toPlace
}
```

**å®¹å·®è®¡ç®—æ¼”è¿›**:
- v2.0: `tolerance = 0.00033 * mid * 0.5` â‰ˆ 0.5Uï¼ˆå¤ªå°ï¼Œé¢‘ç¹æ’¤å•ï¼‰
- v2.1: `tolerance = GridStartOffset * 0.9` = 1.08Uï¼ˆåˆç†ï¼Œæ’¤å•<50/minï¼‰

#### æ’¤å•é¢‘ç‡é™åˆ¶ï¼ˆv2.1å…³é”®ä¿®å¤ï¼‰

**é—®é¢˜**: æ’¤å•è®¡æ•°å™¨åœ¨é«˜é¢‘æ’¤å•åæ°¸ä¹…åœæ­¢æŠ¥ä»·ï¼ˆ"å‡æ­»"ï¼‰

**åŸå› **: 
```go
// é”™è¯¯é€»è¾‘ï¼šæ£€æŸ¥æ’¤å•è®¡æ•°åç«‹å³è¿”å›
if cancelCount >= int(float64(maxCancel)*0.8) {
    log.Warn().Msg("æ’¤å•é¢‘ç‡æ¥è¿‘é™åˆ¶")
    return nil  // âŒ è·³è¿‡æœ¬è½®æŠ¥ä»·
}

// é‡ç½®é€»è¾‘åœ¨åé¢ï¼Œå¦‚æœè·³è¿‡å°±ä¸ä¼šæ‰§è¡Œ
if time.Since(lastReset) > time.Minute {
    cancelCount = 0  // æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œ
}
```

**ä¿®å¤æ–¹æ¡ˆ**: å°†é‡ç½®é€»è¾‘ç§»åˆ°å‡½æ•°å¼€å¤´ï¼Œæ— æ¡ä»¶æ‰§è¡Œ

```go
func processSymbol(ctx context.Context, symbol string) error {
    // 1. æ— æ¡ä»¶æ£€æŸ¥å¹¶é‡ç½®æ’¤å•è®¡æ•°å™¨ï¼ˆé˜²å‡æ­»ï¼‰
    state := store.GetSymbolState(symbol)
    state.Mu.Lock()
    if time.Since(state.LastCancelReset) > time.Minute {
        oldCount := state.CancelCountLast
        state.CancelCountLast = 0
        state.LastCancelReset = time.Now()
        if oldCount > 0 {
            log.Info().Int("reset_from", oldCount).Msg("æ’¤å•è®¡æ•°å™¨å·²é‡ç½®")
        }
    }
    state.Mu.Unlock()
    
    // 2. æ£€æŸ¥æ’¤å•é¢‘ç‡ï¼ˆåªè­¦å‘Šï¼Œä¸è¿”å›ï¼‰
    cancelCount := state.CancelCountLast
    if cancelCount >= int(float64(maxCancel)*0.95) {
        log.Warn().Int("cancel_count", cancelCount).Msg("æ’¤å•é¢‘ç‡æ¥è¿‘é™åˆ¶")
        // ä¸è¿”å›ï¼Œç»§ç»­æ‰§è¡Œ
    }
    
    // 3. ç»§ç»­æ­£å¸¸çš„æŠ¥ä»·ç”Ÿæˆæµç¨‹
    // ...
}
```

---

### 3.5 ä¸»å¾ªç¯åè°ƒ (internal/runner/)

#### æŠ¥ä»·ç”Ÿæˆä¸æ‰§è¡Œæµç¨‹

```go
func (r *Runner) processSymbol(ctx context.Context, symbol string) error {
    // 1. é‡ç½®æ’¤å•è®¡æ•°å™¨ï¼ˆé˜²å‡æ­»ï¼‰
    resetCancelCounter(symbol)
    
    // 2. æ£€æŸ¥æ­¢æŸ
    if err := r.risk.CheckStopLoss(symbol); err != nil {
        log.Error().Err(err).Msg("è§¦å‘æ­¢æŸ")
        return emergencyClose(symbol)
    }
    
    // 3. ç”ŸæˆæŠ¥ä»·
    buyQuotes, sellQuotes, err := r.strategy.GenerateQuotes(ctx, symbol)
    if err != nil {
        return err
    }
    
    // 4. æ‰¹é‡é£æ§é¢„æ£€ï¼ˆv2.1æ–°å¢ï¼‰
    allQuotes := append(buyQuotes, sellQuotes...)
    if err := r.risk.CheckBatchPreTrade(allQuotes, symbol); err != nil {
        log.Warn().Err(err).Msg("æ‰¹é‡é£æ§å¤±è´¥ï¼Œå°è¯•å‡å°‘å±‚æ•°")
        buyQuotes, sellQuotes = adjustQuotesForRisk(buyQuotes, sellQuotes, symbol)
    }
    
    // 5. å•è®¢å•é£æ§
    buyQuotes = filterByPreTrade(buyQuotes, symbol)
    sellQuotes = filterByPreTrade(sellQuotes, symbol)
    
    // 6. è®¢å•å·®åˆ†ï¼ˆé˜²é—ªçƒï¼‰
    activeOrders := r.order.GetActiveOrders(symbol)
    toCancel, toPlace := calculateOrderDiff(
        append(buyQuotes, sellQuotes...), 
        activeOrders, 
        cfg, 
        state,
    )
    
    // 7. æ‰§è¡Œæ’¤å•
    for _, order := range toCancel {
        if err := r.exchange.CancelOrder(ctx, order.ClientOrderID); err != nil {
            log.Error().Err(err).Msg("æ’¤å•å¤±è´¥")
        } else {
            state.CancelCountLast++
        }
    }
    
    // 8. æ‰§è¡Œä¸‹å•
    for _, quote := range toPlace {
        order := convertQuoteToOrder(quote, symbol)
        if err := r.exchange.PlaceOrder(ctx, order); err != nil {
            log.Error().Err(err).Msg("ä¸‹å•å¤±è´¥")
        }
    }
    
    // 9. æ›´æ–°ç›‘æ§æŒ‡æ ‡
    r.metrics.UpdateQuoteMetrics(symbol, buyQuotes, sellQuotes)
    
    return nil
}
```

#### è¯¦ç»†æ—¥å¿—è¾“å‡ºï¼ˆv2.1å¢å¼ºï¼‰

```go
// æŠ¥ä»·ç”Ÿæˆåè¾“å‡ºè¯¦ç»†å‚æ•°
log.Info().
    Str("symbol", cfg.Symbol).
    Float64("mid", state.MidPrice).
    Float64("pos", currentPos).
    Int("buy_layers", len(buyQuotes)).
    Int("sell_layers", len(sellQuotes)).
    Float64("buy1", buyQuotes[0].Price).
    Float64("sell1", sellQuotes[0].Price).
    Float64("buy1_dist", state.MidPrice - buyQuotes[0].Price).
    Float64("sell1_dist", sellQuotes[0].Price - state.MidPrice).
    Float64("buy12_spacing", buyQuotes[0].Price - buyQuotes[1].Price).
    Float64("sell12_spacing", sellQuotes[1].Price - sellQuotes[0].Price).
    Float64("buy_last", buyQuotes[len(buyQuotes)-1].Price).
    Float64("sell_last", sellQuotes[len(sellQuotes)-1].Price).
    Float64("buy_last_spacing", buyQuotes[len(buyQuotes)-2].Price - buyQuotes[len(buyQuotes)-1].Price).
    Float64("sell_last_spacing", sellQuotes[len(sellQuotes)-1].Price - sellQuotes[len(sellQuotes)-2].Price).
    Msg("æŠ¥ä»·å·²ç”Ÿæˆï¼ˆç»Ÿä¸€å‡ ä½•ç½‘æ ¼ï¼‰")
```

---

## å››ã€å…³é”®é—®é¢˜ä¿®å¤è®°å½•

### 4.1 é—®é¢˜ï¼šä»“ä½è¶…é™ï¼ˆé£æ§å¤±æ•ˆï¼‰

**ç°è±¡**: ä»·æ ¼æ³¢åŠ¨ä¸å¤§ï¼ŒæŒä»“æ¥è¿‘æ»¡ä»“ï¼Œæ— æ˜æ˜¾å‡ä»“è¡Œä¸º

**æ ¹æœ¬åŸå› **:
1. åªæ£€æŸ¥å•ä¸ªè®¢å•ï¼Œæœªè¯„ä¼°æ‰€æœ‰è®¢å•çš„ç´¯è®¡é£é™©
2. ç­–ç•¥ç”Ÿæˆçš„è®¢å•æ€»é‡ï¼ˆ0.14 ETHï¼‰è¶…è¿‡é£æ§ä¸Šé™ï¼ˆ0.075 ETHï¼‰

**è§£å†³æ–¹æ¡ˆ**:
- âœ… å®ç° `CheckBatchPreTrade` æ‰¹é‡é£æ§é¢„æ£€
- âœ… æ·»åŠ  `adjustQuotesForRisk` åŠ¨æ€å‡å°‘å±‚æ•°
- âœ… ä¿®æ”¹ `generateNormalQuotes` ä½¿å…¶æ ¹æ®æŒä»“æ¯”ä¾‹å‡å°‘è®¢å•

**éªŒè¯**: å®ç›˜æµ‹è¯•æ˜¾ç¤ºæŒä»“å§‹ç»ˆ<NetMaxï¼Œæ‰¹é‡é£æ§æ—¥å¿—æ­£å¸¸

---

### 4.2 é—®é¢˜ï¼šä¹°1å–1è·ç¦»midåè¿œ

**ç°è±¡**: buy1/sell1 è·ç¦» mid 4-5Uï¼Œåº”ä¸º 1-1.5U

**æ ¹æœ¬åŸå› **:
- `near_layer_start_offset: 0.00016` å¤ªå°ï¼ˆ0.48Uï¼‰
- Post-Only è®¢å•è¢«äº¤æ˜“æ‰€æ‹’ç»ï¼ˆ-5022é”™è¯¯ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
- âœ… è°ƒæ•´ `grid_start_offset: 1.2`ï¼ˆ1.2Uï¼‰
- âœ… è°ƒæ•´ `min_spread: 0.0007`ï¼ˆå…è®¸æ›´ç´§ä»·å·®ï¼‰

**éªŒè¯**: å®ç›˜æµ‹è¯•æ˜¾ç¤º buy1/sell1 è· mid 1.2Uï¼Œä»·å·® 2.4U âœ…

---

### 4.3 é—®é¢˜ï¼šç³»ç»Ÿ"å‡æ­»"ï¼ˆä¸å†æŒ‚å•ï¼‰

**ç°è±¡**: ç³»ç»Ÿè¿è¡Œä¸­åæœŸåœæ­¢æŒ‚å•ï¼Œå³ä½¿æŒä»“æ¸…ç©ºæˆ–ä»·æ ¼æ³¢åŠ¨ä¹Ÿä¸æ¢å¤

**æ ¹æœ¬åŸå› **: æ’¤å•è®¡æ•°å™¨é‡ç½®é€»è¾‘åœ¨ `return nil` ä¹‹åï¼Œå¯¼è‡´æ°¸ä¸æ‰§è¡Œ

**è§£å†³æ–¹æ¡ˆ**:
- âœ… å°† `CancelCountLast` é‡ç½®é€»è¾‘ç§»åˆ° `processSymbol` å¼€å¤´
- âœ… åˆ é™¤ `return nil`ï¼Œæ”¹ä¸ºä»…è®°å½•è­¦å‘Š

**éªŒè¯**: å®ç›˜æµ‹è¯•æ˜¾ç¤ºç³»ç»Ÿåœ¨é«˜æ’¤å•å1åˆ†é’Ÿå†…è‡ªåŠ¨æ¢å¤ âœ…

---

### 4.4 é—®é¢˜ï¼šé…ç½®ä¸ç”Ÿæ•ˆï¼ˆçƒ­é‡è½½å¤±è´¥ï¼‰

**ç°è±¡**: ä¿®æ”¹ `total_layers: 18`ï¼Œä½†å®é™…ç”Ÿæˆ24å±‚è®¢å•

**æ ¹æœ¬åŸå› **: Go çš„ `range` å¾ªç¯ä¼ å€¼å¤åˆ¶ï¼Œä¿®æ”¹å‰¯æœ¬ä¸å½±å“åŸæ•°æ®

```go
// é”™è¯¯ä»£ç ï¼š
for i, sym := range cfg.Symbols {
    sym.TotalLayers = 18  // ä¿®æ”¹çš„æ˜¯å‰¯æœ¬
}

// æ­£ç¡®ä»£ç ï¼š
for i := range cfg.Symbols {
    sym := &cfg.Symbols[i]  // ä½¿ç”¨æŒ‡é’ˆ
    sym.TotalLayers = 18
    cfg.Symbols[i] = *sym   // æ˜¾å¼èµ‹å€¼
}
```

**è§£å†³æ–¹æ¡ˆ**: âœ… ä¿®æ”¹ `validateConfig` ä½¿ç”¨æŒ‡é’ˆæ“ä½œ

**éªŒè¯**: é…ç½®ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼Œæ—¥å¿—æ˜¾ç¤ºæ­£ç¡®çš„å±‚æ•° âœ…

---

### 4.5 é—®é¢˜ï¼šæŒä»“æ—¶æ— å–å•ï¼ˆæ— æ³•å¹³ä»“ï¼‰

**ç°è±¡**: å¤šå¤´æŒä»“0.021 ETHï¼Œåªæœ‰20å±‚è®¢å•ï¼ˆåº”36å±‚ï¼‰ï¼Œä¸”æ— å–å•

**æ ¹æœ¬åŸå› **:
1. `net_max: 0.15` å¤ªå°ï¼Œæ‰¹é‡é£æ§é™åˆ¶ `maxWorstCase = 0.075`
2. `CheckBatchPreTrade` åŒæ—¶é™åˆ¶ä¹°å–æ–¹å‘ï¼Œé˜»æ­¢å¹³ä»“å–å•

**è§£å†³æ–¹æ¡ˆ**:
- âœ… æé«˜ `net_max: 0.30`ï¼ˆæ”¯æŒ36å±‚ï¼‰
- âœ… ä¿®æ”¹ç­–ç•¥ï¼šæŒä»“æ—¶ä¿æŒå¹³ä»“æ–¹å‘çš„å±‚æ•°
- âœ… ä¿®æ”¹é£æ§ï¼šåªé™åˆ¶åŠ ä»“æ–¹å‘ï¼Œä¸é™åˆ¶å¹³ä»“æ–¹å‘

**éªŒè¯**: å®ç›˜æµ‹è¯•æ˜¾ç¤ºå¤šå¤´æ—¶æœ‰18å±‚å–å•ï¼Œå¯æ­£å¸¸å¹³ä»“ âœ…

---

### 4.6 é—®é¢˜ï¼šé«˜æ’¤å•ç‡ï¼ˆ402/minï¼‰

**ç°è±¡**: æ’¤å•é¢‘ç‡è¿œè¶…50/miné™åˆ¶ï¼Œå¯èƒ½è§¦å‘APIé™åˆ¶

**æ ¹æœ¬åŸå› **:
1. `quote_interval_ms: 200`ï¼ˆ200msï¼‰å¤ªæ¿€è¿›
2. `tolerance` è®¡ç®—ä½¿ç”¨é”™è¯¯çš„å‚æ•°ï¼ˆ`NearLayerStartOffset`ï¼‰
3. å®¹å·®å› å­0.7å¤ªå°

**è§£å†³æ–¹æ¡ˆ**:
- âœ… æé«˜ `quote_interval_ms: 1000`ï¼ˆ1ç§’ï¼‰
- âœ… ä¿®æ”¹å®¹å·®è®¡ç®—ï¼š`tolerance = GridStartOffset * 0.9`
- âœ… ä½¿ç”¨ç¬¬ä¸€å±‚è·ç¦»ï¼ˆ1.2Uï¼‰è€Œéè¿‡æ—¶çš„offset

**éªŒè¯**: å®ç›˜æµ‹è¯•æ˜¾ç¤ºæ’¤å•ç‡<50/minï¼Œé˜²é—ªçƒå®¹å·®1.08U âœ…

---

## äº”ã€ç›‘æ§ä¸è¿ç»´

### 5.1 å…³é”®ç›‘æ§æŒ‡æ ‡

#### Prometheus æŒ‡æ ‡

```go
// ä»“ä½æŒ‡æ ‡
mm_position{symbol="ETHUSDC"} 0.021

// æŒ‚å•æŒ‡æ ‡
mm_active_orders{symbol="ETHUSDC"} 36
mm_pending_buy{symbol="ETHUSDC"} 0.126
mm_pending_sell{symbol="ETHUSDC"} 0.126

// æ’¤å•æŒ‡æ ‡ï¼ˆå…³é”®ï¼‰
mm_cancel_count{symbol="ETHUSDC"} 42

// é£æ§æŒ‡æ ‡
mm_batch_risk_reject_total{symbol="ETHUSDC"} 0
mm_stop_loss_trigger{symbol="ETHUSDC"} 0

// æ€§èƒ½æŒ‡æ ‡
mm_quote_generation_duration_seconds{symbol="ETHUSDC"} 0.023
mm_order_placement_duration_seconds{symbol="ETHUSDC"} 0.156
```

#### æ—¥å¿—å…³é”®å­—

```bash
# ç›‘æ§æ’¤å•ç‡
grep "æ’¤å•è®¡æ•°å™¨å·²é‡ç½®" logs/phoenix_live.out | tail -10

# ç›‘æ§æ‰¹é‡é£æ§
grep "æ‰¹é‡é£æ§" logs/phoenix_live.out | tail -10

# ç›‘æ§å‡ ä½•ç½‘æ ¼å‚æ•°
grep "æŠ¥ä»·å·²ç”Ÿæˆï¼ˆç»Ÿä¸€å‡ ä½•ç½‘æ ¼ï¼‰" logs/phoenix_live.out | tail -5

# ç›‘æ§é˜²é—ªçƒå®¹å·®
grep "é˜²é—ªçƒå®¹å·®è®¡ç®—å®Œæˆ" logs/phoenix_live.out | tail -5
```

### 5.2 è¿ç»´è„šæœ¬

#### å¯åŠ¨è„šæœ¬ (scripts/start.sh)

```bash
#!/bin/bash
cd /root/market-maker-go

# æ£€æŸ¥è¿›ç¨‹
if pgrep -f "phoenix -config" > /dev/null; then
    echo "Phoenixå·²åœ¨è¿è¡Œ"
    exit 1
fi

# å¯åŠ¨
nohup ./bin/phoenix \
    -config=configs/phoenix_live.yaml \
    -log=info \
    > logs/phoenix_live.out 2>&1 &

echo "Phoenixå·²å¯åŠ¨ï¼ŒPID: $!"
```

#### ç´§æ€¥åœæ­¢è„šæœ¬ (scripts/emergency_stop.sh)

```bash
#!/bin/bash
# 1. åœæ­¢è¿›ç¨‹
pkill -f "phoenix -config"

# 2. æ’¤é”€æ‰€æœ‰è®¢å•
./bin/emergency -config=configs/phoenix_live.yaml -action=cancel

# 3. å¹³ä»“ï¼ˆå¦‚éœ€è¦ï¼‰
# ./bin/emergency -config=configs/phoenix_live.yaml -action=close
```

### 5.3 å‘Šè­¦è§„åˆ™

```yaml
# prometheus/alerts.yml
groups:
  - name: phoenix_alerts
    rules:
      # æ’¤å•ç‡å‘Šè­¦
      - alert: HighCancelRate
        expr: rate(mm_cancel_count[1m]) > 50
        for: 2m
        annotations:
          summary: "æ’¤å•ç‡è¶…é™: {{ $value }}/min"
      
      # ä»“ä½å‘Šè­¦
      - alert: PositionOverLimit
        expr: abs(mm_position) > 0.25
        for: 1m
        annotations:
          summary: "ä»“ä½æ¥è¿‘ä¸Šé™: {{ $value }} ETH"
      
      # æ­¢æŸå‘Šè­¦
      - alert: StopLossTriggered
        expr: mm_stop_loss_trigger > 0
        annotations:
          summary: "è§¦å‘æ­¢æŸ: {{ $labels.symbol }}"
```

---

## å…­ã€éƒ¨ç½²ä¸æ‰©å±•

### 6.1 æœ¬åœ°éƒ¨ç½²

```bash
# 1. æ„å»º
cd /root/market-maker-go
go build -o bin/phoenix cmd/phoenix/main.go

# 2. é…ç½®
cp configs/phoenix_live.yaml.example configs/phoenix_live.yaml
# ç¼–è¾‘ API key/secret

# 3. å¯åŠ¨
./scripts/start.sh

# 4. ç›‘æ§
tail -f logs/phoenix_live.out
```

### 6.2 Docker éƒ¨ç½²

```dockerfile
# Dockerfile
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -ldflags="-s -w" -o phoenix cmd/phoenix/main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/phoenix .
COPY --from=builder /app/configs ./configs
CMD ["./phoenix", "-config=configs/phoenix_live.yaml"]
```

```bash
# æ„å»ºé•œåƒ
docker build -t phoenix-mm:v2.1 .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name phoenix \
  -v $(pwd)/configs:/root/configs \
  -v $(pwd)/logs:/root/logs \
  -p 9090:9090 \
  phoenix-mm:v2.1
```

### 6.3 æ€§èƒ½è°ƒä¼˜å»ºè®®

1. **æ’¤å•ç‡ä¼˜åŒ–**:
   - é™ä½ `quote_interval_ms`ï¼ˆä½†ä¸ä½äº500msï¼‰
   - æé«˜ `tolerance` å› å­ï¼ˆ0.9-1.0ï¼‰
   - æ ¹æ®å¸‚åœºæ³¢åŠ¨ç‡åŠ¨æ€è°ƒæ•´

2. **ä»“ä½åˆ©ç”¨ç‡**:
   - å°èµ„é‡‘ï¼ˆ<1000 USDCï¼‰ï¼š`net_max = 0.20-0.30`
   - ä¸­èµ„é‡‘ï¼ˆ1k-5k USDCï¼‰ï¼š`net_max = 0.15-0.25`
   - å¤§èµ„é‡‘ï¼ˆ>5k USDCï¼‰ï¼šè€ƒè™‘å¤šsymbolåˆ†æ•£

3. **ç½‘æ ¼å‚æ•°è°ƒä¼˜**:
   - é«˜æ³¢åŠ¨ç‡å¸‚åœºï¼šå¢å¤§ `grid_start_offset`ï¼ˆ1.5-2.0Uï¼‰
   - ä½æ³¢åŠ¨ç‡å¸‚åœºï¼šå‡å° `grid_spacing_multiplier`ï¼ˆ1.1-1.12ï¼‰
   - æ·±åº¦ä¸è¶³æ—¶ï¼šå‡å°‘ `total_layers`ï¼ˆ12-15å±‚ï¼‰

---

## ä¸ƒã€å·²çŸ¥é—®é¢˜ä¸å¾…åŠ

### 7.1 å·²çŸ¥é—®é¢˜

1. **Pinningæ¨¡å¼ç¼ºé™·**ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰
   - ç—‡çŠ¶ï¼šå¤šå¤´æ—¶ä¹°1å–1ä»·å·®å¯èƒ½è¾¾åˆ°10U+
   - åŸå› ï¼šç¼ºå°‘è¿‘ç«¯ä¹°å•é˜²æŠ¤
   - ä¸´æ—¶æ–¹æ¡ˆï¼šç¦ç”¨ Pinningï¼ˆ`pinning_enabled: false`ï¼‰
   - æ°¸ä¹…ä¿®å¤ï¼šé‡å†™ `generatePinningQuotes` æ·»åŠ è¿‘ç«¯å¯¹å†²

2. **WebSocketé‡è¿å»¶è¿Ÿ**ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰
   - ç—‡çŠ¶ï¼šWSSæ–­å¼€åé‡è¿å¯èƒ½éœ€è¦5-10ç§’
   - å½±å“ï¼šçŸ­æš‚åœæ­¢æŠ¥ä»·
   - ä¼˜åŒ–æ–¹å‘ï¼šå‡å°‘é‡è¿é—´éš”ï¼Œå¢åŠ å¥åº·æ£€æŸ¥

3. **é…ç½®çƒ­é‡è½½éªŒè¯ä¸å®Œæ•´**ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰
   - ç—‡çŠ¶ï¼šæŸäº›é…ç½®ä¿®æ”¹å¯èƒ½è¢«é™é»˜å¿½ç•¥
   - ä¼˜åŒ–æ–¹å‘ï¼šå¢å¼ºéªŒè¯æ—¥å¿—

### 7.2 å¾…åŠäº‹é¡¹

- [ ] å®ç°å¤šsymbolæ”¯æŒï¼ˆBTCUSDC, SOLUSDCï¼‰
- [ ] å¢åŠ å›æµ‹å·¥å…·ï¼ˆå†å²æ•°æ®éªŒè¯ï¼‰
- [ ] ä¼˜åŒ–Grindingæ¨¡å¼çš„takeré€»è¾‘
- [ ] å®ç°èµ„é‡‘è´¹ç‡å¯¹å†²ç­–ç•¥
- [ ] æ·»åŠ Grafanaé¢æ¿æ¨¡æ¿

---

## å…«ã€æµ‹è¯•ä¸éªŒè¯

### 8.1 å•å…ƒæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./... -v -cover

# ç­–ç•¥æµ‹è¯•
go test ./internal/strategy -v

# é£æ§æµ‹è¯•ï¼ˆåŒ…å«æ‰¹é‡é¢„æ£€ï¼‰
go test ./internal/risk -v

# è®¢å•ç®¡ç†æµ‹è¯•
go test ./internal/order -v
```

### 8.2 å®ç›˜éªŒæ”¶æ ‡å‡†

#### åŠŸèƒ½éªŒæ”¶
- âœ… 36å±‚è®¢å•å®Œå…¨æŒ‚å‡ºï¼ˆ18ä¹°+18å–ï¼‰
- âœ… buy1/sell1 è·mid 1.2Uï¼Œä»·å·®2.4U
- âœ… æ’¤å•ç‡ <50/min
- âœ… æ‰¹é‡é£æ§é€šè¿‡ï¼Œæ— è¶…é™æŠ¥è­¦
- âœ… æŒä»“è‡ªé€‚åº”ï¼šå¤šå¤´æ—¶ä¿æŒ18å±‚å–å•

#### æ€§èƒ½éªŒæ”¶
- âœ… æŠ¥ä»·ç”Ÿæˆå»¶è¿Ÿ <50ms (p99)
- âœ… è®¢å•ä¸‹è¾¾å»¶è¿Ÿ <200ms (p99)
- âœ… å†…å­˜å ç”¨ <100MB
- âœ… CPUå ç”¨ <20%

#### å¯é æ€§éªŒæ”¶
- âœ… 72hè¿ç»­è¿è¡Œæ— crash
- âœ… é«˜æ’¤å•åè‡ªåŠ¨æ¢å¤ï¼ˆ1åˆ†é’Ÿå†…ï¼‰
- âœ… é…ç½®çƒ­é‡è½½æ— éœ€é‡å¯
- âœ… WSSæ–­å¼€è‡ªåŠ¨é‡è¿

---

## ä¹ã€ç‰ˆæœ¬å˜æ›´æ—¥å¿—

### v2.1 (2025-11-30)

**æ ¸å¿ƒæ›´æ–°**:
- âœ… **ç»Ÿä¸€å‡ ä½•ç½‘æ ¼ç®—æ³•**: æ›¿ä»£åŒå±‚ç³»ç»Ÿï¼Œç²¾ç¡®æ§åˆ¶36å±‚è®¢å•åˆ†å¸ƒ
- âœ… **æ‰¹é‡é£æ§é¢„æ£€**: è¯„ä¼°æ‰€æœ‰è®¢å•ç´¯è®¡é£é™©ï¼Œæ”¯æŒåŠ¨æ€è°ƒæ•´å±‚æ•°
- âœ… **é˜²é—ªçƒä¼˜åŒ–**: å®¹å·®ä»0.5Uæå‡è‡³1.08Uï¼Œæ’¤å•ç‡é™è‡³50/minä»¥ä¸‹
- âœ… **æŒä»“è‡ªé€‚åº”ä¿®å¤**: å¤šå¤´æ—¶ä¿æŒå–å•ã€å‡å°‘ä¹°å•ï¼Œç¡®ä¿å¯å¹³ä»“
- âœ… **å‡æ­»é—®é¢˜ä¿®å¤**: æ’¤å•è®¡æ•°å™¨æ— æ¡ä»¶é‡ç½®ï¼Œé¿å…æ°¸ä¹…åœæ­¢
- âœ… **é…ç½®çƒ­é‡è½½ä¿®å¤**: ä½¿ç”¨æŒ‡é’ˆæ“ä½œï¼Œç¡®ä¿é…ç½®ä¿®æ”¹ç”Ÿæ•ˆ

**é…ç½®å˜æ›´**:
- `net_max: 0.15 â†’ 0.30`ï¼ˆæ”¯æŒ36å±‚è®¢å•ï¼‰
- `quote_interval_ms: 200 â†’ 1000`ï¼ˆé™ä½æ’¤å•é¢‘ç‡ï¼‰
- æ–°å¢ `grid_*` ç³»åˆ—å‚æ•°ï¼ˆå‡ ä½•ç½‘æ ¼é…ç½®ï¼‰
- `unified_layer_size: 0.0067 â†’ 0.007`

**æ€§èƒ½æå‡**:
- æ’¤å•ç‡: 402/min â†’ <50/min âœ…
- è®¢å•æ•°é‡: 20å±‚ â†’ 36å±‚ âœ…
- ä¹°1å–1ä»·å·®: 4-5U â†’ 2.4U âœ…
- ç³»ç»Ÿå¯ç”¨æ€§: å‡æ­»é—®é¢˜æ¶ˆé™¤ âœ…

**æ–‡æ¡£æ›´æ–°**:
- æ–°å¢ `CHANGELOG.md`ï¼ˆè¯¦ç»†å˜æ›´æ—¥å¿—ï¼‰
- æ–°å¢ `ANTI_FLICKER_FIX.md`ï¼ˆé˜²é—ªçƒä¼˜åŒ–æ–‡æ¡£ï¼‰
- æ›´æ–°æœ¬æ–‡æ¡£è‡³ v2.1

### v2.0 (2025-11-28)

- é¦–æ¬¡ç”Ÿäº§éƒ¨ç½²ç‰ˆæœ¬
- å®ç°ASMMç­–ç•¥+é£æ§+è®¢å•ç®¡ç†
- æ”¯æŒPinning/Grindingæ¨¡å¼
- Prometheusç›‘æ§é›†æˆ

### v1.0 (2025-11-27)

- Phoenixé‡æ„è“å›¾
- æ¶æ„è®¾è®¡ä¸æ¨¡å—è§„åˆ’

---

## åã€è´¡çŒ®ä¸æ”¯æŒ

### 10.1 ä»£ç è§„èŒƒ

- éµå¾ª Go å®˜æ–¹é£æ ¼æŒ‡å—
- ä½¿ç”¨ `golangci-lint` è¿›è¡Œä»£ç æ£€æŸ¥
- æ¯ä¸ª public å‡½æ•°å¿…é¡»æœ‰ godoc æ³¨é‡Š
- æäº¤ä¿¡æ¯éµå¾ª Conventional Commits

### 10.2 Issue æäº¤

æŠ¥å‘Šé—®é¢˜æ—¶è¯·åŒ…å«ï¼š
1. ç³»ç»Ÿç‰ˆæœ¬ï¼ˆ`git rev-parse HEAD`ï¼‰
2. é…ç½®æ–‡ä»¶ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
3. æ—¥å¿—ç‰‡æ®µï¼ˆæœ€è¿‘50è¡Œï¼‰
4. å¤ç°æ­¥éª¤

### 10.3 Pull Request

1. Fork ä»“åº“åˆ°ä¸ªäººè´¦å·
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ï¼ˆ`git checkout -b feature/xxx`ï¼‰
3. æäº¤å˜æ›´ï¼ˆ`git commit -am 'feat: add xxx'`ï¼‰
4. æ¨é€åˆ°åˆ†æ”¯ï¼ˆ`git push origin feature/xxx`ï¼‰
5. åˆ›å»º Pull Request åˆ° `dev` åˆ†æ”¯

---

## é™„å½•

### A. æœ¯è¯­è¡¨

- **ASMM**: Adaptive Skewed Market Makingï¼Œè‡ªé€‚åº”åæ–œåšå¸‚
- **NetMax**: æœ€å¤§å‡€ä»“ä½é™åˆ¶
- **Pinning**: é’‰å­æ¨¡å¼ï¼Œè®¢å•é’‰åœ¨æœ€ä¼˜ä¹°å–ä»·
- **Grinding**: ç£¨æˆæœ¬æ¨¡å¼ï¼Œä¸»åŠ¨å¹³ä»“é™ä½åº“å­˜æˆæœ¬
- **Inventory Skew**: åº“å­˜åç§»ï¼Œæ ¹æ®æŒä»“è°ƒæ•´æŠ¥ä»·ä¸­å¿ƒ
- **Batch Pre-Trade**: æ‰¹é‡é£æ§é¢„æ£€ï¼Œä¸‹å•å‰è¯„ä¼°ç´¯è®¡é£é™©
- **Anti-Flicker**: é˜²é—ªçƒæœºåˆ¶ï¼Œé¿å…ä¸å¿…è¦çš„æ’¤å•é‡æŒ‚
- **Geometric Grid**: å‡ ä½•ç½‘æ ¼ï¼Œè®¢å•é—´è·æŒ‰å‡ ä½•çº§æ•°å¢é•¿

### B. å…¬å¼é€ŸæŸ¥

```
# å‡ ä½•ç½‘æ ¼è·ç¦»
distance(n) = GridStartOffset + Î£[i=0 to n-1](GridFirstSpacing Ã— GridSpacingMultiplier^i)

# åº“å­˜åç§»
inventorySkew = -(pos / NetMax) Ã— InventorySkewCoeff Ã— MidPrice

# Reservationä»·æ ¼
reservation = MidPrice + inventorySkew + fundingBias

# ä¹°å–ä»·æ ¼
buyPrice(n) = reservation - distance(n)
sellPrice(n) = reservation + distance(n)

# æ‰¹é‡é£æ§æœ€åæƒ…å†µ
worstCaseLong = currentPos + Î£(buyOrders.size)
worstCaseShort = currentPos - Î£(sellOrders.size)
maxWorstCase = NetMax Ã— 0.5

# é˜²é—ªçƒå®¹å·®
tolerance = GridStartOffset Ã— 0.9
```

### C. å‚è€ƒèµ„æ–™

- [Binance USDC-margined Futures API](https://binance-docs.github.io/apidocs/delivery/en/)
- [å¸‚åœºåšå¸‚ç­–ç•¥è®ºæ–‡é›†](https://github.com/Newplayman/market-maker-go/docs/papers/)
- [Goå¹¶å‘æ¨¡å¼](https://go.dev/blog/pipelines)
- [Prometheusæœ€ä½³å®è·µ](https://prometheus.io/docs/practices/)

---

**ç­¾å**: AI Assistant & User  
**æœ€åæ›´æ–°**: 2025-11-30  
**çŠ¶æ€**: âœ… ç”Ÿäº§éªŒè¯é€šè¿‡

**License**: Apache 2.0  
**Repository**: https://github.com/Newplayman/market-maker-go  
**Branch**: dev

---

**ä¸‹ä¸€æ­¥è®¡åˆ’**:
1. ä¿®å¤Pinningæ¨¡å¼è¿‘ç«¯è®¢å•ç¼ºå¤±
2. å®ç°å¤šsymbolæ”¯æŒ
3. å¢åŠ å†å²å›æµ‹å·¥å…·
4. ä¼˜åŒ–WebSocketé‡è¿æœºåˆ¶
5. éƒ¨ç½²åˆ°K8sç”Ÿäº§ç¯å¢ƒ

