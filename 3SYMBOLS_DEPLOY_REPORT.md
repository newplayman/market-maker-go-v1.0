# 3交易对部署报告（流量优化）

**部署时间**: 2025-12-02 18:23:19 UTC  
**交易对**: ETHUSDC, BNBUSDC, XRPUSDC  
**目标**: 降低WebSocket流量40%，观察断流问题

---

## ✅ 配置变更

### 交易对调整
- ✅ **保留**: ETHUSDC, BNBUSDC, XRPUSDC
- ❌ **移除**: DOGEUSDC, SOLUSDC

### 全局配置调整
- ✅ `total_notional_max`: 4000 → **2400** (3个交易对总名义价值约2400 USDC)
- ✅ `max_cancel_per_min`: 保持40 (3个交易对共享200限制，更安全)

### 资金分配
- ETHUSDC: 75 USDC (62.5%权重) - 1500名义价值
- BNBUSDC: 30 USDC (25%权重) - 600名义价值  
- XRPUSDC: 15 USDC (12.5%权重) - 300名义价值
- **总计**: 120 USDC (12%资金使用率)

---

## 📊 预期效果

### 流量优化
- **WebSocket流减少**: 从5个交易对降到3个，预计流量降低**40%**
- **压缩已启用**: `permessage-deflate`，预计再降低30-40%
- **消息限流**: 价格变化<0.01%的更新被过滤
- **总预期**: 流量从700k+降至**200-300k左右**

### 断流问题观察
- **检测优化**: 2秒内检测断流
- **自动重连**: 5秒内自动重连
- **需要观察**: 3交易对是否减少断流频率

---

## 🔍 监控要点

### 1. 流量监控
```bash
# 启动流量监控
./scripts/monitor_traffic.sh

# 或查看Prometheus指标
curl http://localhost:9090/metrics | grep phoenix_ws_bandwidth
```

**预期**: 流量降至200-300k/分钟

### 2. 断流监控
```bash
# 监控断流告警
tail -f logs/phoenix_live.out | grep -E "(价格数据过期|深度数据停止|WebSocket.*重连)"
```

**观察点**:
- 断流频率是否降低
- 重连是否及时（5秒内）
- 是否仍有"深度数据停止更新"告警

### 3. 交易对状态
```bash
# 检查交易对运行状态
tail -f logs/phoenix_live.out | grep -E "(报价已生成|同步活跃订单)" | grep -E "(ETHUSDC|BNBUSDC|XRPUSDC)"
```

**预期**: 3个交易对都正常生成报价，每个14个活跃订单

---

## ⚠️ 已知问题

### 问题：WebSocket频繁断流

**现象**:
- 日志中仍有"深度数据停止更新，WebSocket可能断流"告警
- 重连后很快又断开

**可能原因**:
1. Binance服务器端限制（频繁重连可能被限流）
2. 网络不稳定
3. combined stream订阅问题

**已实施的修复**:
- ✅ 自动重连机制
- ✅ 2秒断流检测
- ✅ 5秒防抖重连
- ✅ 心跳检测（每20秒ping）

**需要观察**:
- 3交易对是否减少断流频率
- 如果仍频繁，可能需要进一步优化（如增加重连延迟）

---

## 📝 后续计划

### 如果流量仍高（>400k）
1. 进一步优化消息过滤（如只处理关键价格档位）
2. 考虑降低depth更新频率（如`@depth20@500ms`）
3. 或进一步减少交易对（保留2个）

### 如果断流仍频繁
1. 增加重连延迟（从2秒增加到5秒）
2. 实施指数退避重连策略
3. 考虑使用REST API轮询替代部分WebSocket流

---

## ✅ 部署状态

- ✅ 配置文件已更新（只保留3个交易对）
- ✅ 服务已重启（PID: 3219538）
- ✅ 订单正常下达（ETH/BNB/XRP都在下单）
- ⏳ 需要持续观察流量和断流问题

---

**下一步**: 持续监控流量和断流频率，确认优化效果。


