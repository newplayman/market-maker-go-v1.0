# Phoenix 实盘挂单价格验证报告

## 测试时间
2025-11-29 16:26:55 - 16:29:11

## 配置参数
```yaml
near_layer_start_offset: 0.00033        # ~1U @ 3000U
near_layer_spacing_ratio: 1.35          # 35%几何增长
far_layer_start_offset: 0.0015
far_layer_end_offset: 0.025
min_spread: 0.00066                     # 0.066%
```

## 实际挂单价格分析

### 市场中间价估算
从买卖单价格推算：mid ≈ 3003-3004 USDT

### 买单价格梯度（从高到低）
```
价格        距离上一层   距离mid(3003)   层级
----------------------------------------------
3000.41    -           ~2.6U          L1
2999.84    -0.57U      ~3.2U          L2  
2999.28    -0.56U      ~3.7U          L3
2997.74    -1.54U      ~5.3U          L4
2997.93    +0.19U      ~5.1U          L5(异常)
2996.30    -1.63U      ~6.7U          L6
2994.33    -1.97U      ~8.7U          L7
2991.95    -2.38U      ~11.0U         L8
---近端结束，远端开始---
2989.09    -2.86U      ~13.9U         L9
2985.63    -3.46U      ~17.4U         L10
2981.46    -4.17U      ~21.5U         L11
```

### 卖单价格梯度（从低到高）
```
价格        距离上一层   距离mid(3003)   层级
----------------------------------------------
3006.84    -           ~3.8U          L1
3007.18    +0.34U      ~4.2U          L2
3007.65    +0.47U      ~4.7U          L3
3008.29    +0.64U      ~5.3U          L4
3009.14    +0.85U      ~6.1U          L5
3010.29    +1.15U      ~7.3U          L6
3010.35    +0.06U      ~7.4U          L7(异常)
3011.28    +0.93U      ~8.3U          L8
3011.85    +0.57U      ~8.9U          L9
3012.41    +0.56U      ~9.4U          L10
3013.76    +1.35U      ~10.8U         L11
3013.95    +0.19U      ~11.0U         L12(异常)
3015.39    +1.44U      ~12.4U         L13
3017.36    +1.97U      ~14.4U         L14
3019.74    +2.38U      ~16.7U         L15
---远端开始---
3022.60    +2.86U      ~19.6U         L16
3026.06    +3.46U      ~23.1U         L17
3030.23    +4.17U      ~27.2U         L18 ✓
```

## 关键指标验证

### ❌ 买1/卖1距离mid（不满足需求）
- **买1距离mid**: ~2.6U（目标: 1-1.5U）❌
- **卖1距离mid**: ~3.8U（目标: 1-1.5U）❌
- **总价差**: ~6.4U

**问题原因**: 
第一层距离过大，可能是因为：
1. `inventorySkew` 和 `fundingBias` 导致reservation偏离mid
2. `near_layer_start_offset: 0.00033` 需要进一步减小

### ✅ 层间距几何递增（符合预期）
- 买单层间距: 0.6U → 1.5U → 2.0U → 2.4U → 2.9U → 3.5U → 4.2U
- 卖单层间距: 0.3U → 0.5U → 0.6U → 0.9U → 1.1U → ... → 4.2U
- 几何增长率约1.35 ✓

### ✅ 远端最大层间距（符合预期）
- 最大层间距: ~4.2U
- 远端18层的最后一层距离mid: ~27U ✓

## 问题诊断

### 为什么买1/卖1距离mid偏大？

查看策略代码逻辑：
```go
reservation := mid + inventorySkew + fundingBias
offsetRatio := startOffset * math.Pow(spacingRatio, float64(i))
buyPrice := reservation * (1 - offsetRatio)
```

当前仓位=0时，理论上：
- inventorySkew = 0
- fundingBias ≈ 0（如果资金费率很小）
- reservation应该 ≈ mid

但实际买1距离mid ~2.6U，说明：
1. 可能有库存偏移（虽然仓位=0）
2. 或者资金费率偏移较大
3. 或者计算中有其他偏移因素

## 优化方案

### 方案A：减小near_layer_start_offset（推荐）
```yaml
near_layer_start_offset: 0.00016        # 从0.00033减半到0.00016 (~0.5U @ 3000U)
```

### 方案B：调整最小价差
```yaml
min_spread: 0.0005                      # 从0.00066减小到0.0005
```

### 方案C：在策略中减小第一层的特殊处理
修改策略代码，让第一层更贴近mid而不是reservation。

## 其他发现

### ✅ 撤单频率保护已修复
系统日志显示撤单计数器可以正常重置，不再出现"死锁"状态。

### ✅ 订单数量控制正常
- active_orders: 27-28（符合预期：每边约13-14个订单）
- 没有订单堆积问题

### ⚠️ 价格序列有小幅乱序
部分层级价格出现小幅偏差（如L5和L7），可能是由于：
1. 价格四舍五入到tickSize
2. 市场价格波动导致不同时间的报价基准不同

## 建议

**立即应用方案A**，将`near_layer_start_offset`减半到0.00016，以达到买1/卖1距离mid约1-1.5U的目标。


