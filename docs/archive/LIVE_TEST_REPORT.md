# 实盘测试初步报告

## 时间
2025-11-30 11:30-11:32 (2分钟测试)

## ✅ 策略逻辑验证

### 订单成交后重新挂单机制

**验证结果：✅ 逻辑正确**

通过代码分析确认：
1. **订单成交触发** (`onOrderUpdate`) - WebSocket实时接收成交通知
2. **仓位更新** (`onAccountUpdate`) - 更新Store中的Position
3. **定时报价循环** (每200ms) - 基于**最新仓位**重新生成报价
4. **动态调整**：
   ```
   多头仓位(pos > 0) → 减少买单层数 + 保持/增加卖单层数
   空头仓位(pos < 0) → 减少卖单层数 + 保持/增加买单层数
   ```

**这意味着：**
- 当买单成交(价格下跌) → 持有多头 → 系统自动增加卖单 → 等待反抽平仓 ✅
- 当卖单成交(价格上涨) → 持有空头 → 系统自动增加买单 → 等待回落平仓 ✅

## ⚠️ 配置未生效问题

### 发现的问题

1. **系统生成24层而不是18层**
   - 配置目标：`total_layers: 18`
   - 实际生成：24层（旧配置的near_layers+far_layers=3+4=7，但日志显示24）
   
2. **订单大小未更新**
   - 配置目标：`unified_layer_size: 0.007`
   - 实际使用：0.01 (旧配置)

3. **批量风控正常工作**
   - 检测到24层×0.01=0.24 ETH > 0.075限制
   - 自动调整为8层×0.01=0.08 ETH（接近限制但可接受）

### 根本原因

系统可能使用了旧的二进制文件或配置缓存。需要：
1. 重新编译程序
2. 清理缓存
3. 确保新配置加载

## 📊 当前运行状态

### 挂单情况
```
活跃订单: 14个
买单挂单量: 0.07 ETH
卖单挂单量: 0.07 ETH
```

### 价格分布（基于日志）
```
买1: ~2999.99 USDT
卖1: ~3004.57 USDT
买1卖1价差: ~4.6U
```

**⚠️ 问题：** 买1卖1价差4.6U，超过目标1-1.5U！

### 下单失败原因
```
ERR 下单失败 error="Order's notional must be no smaller than 20"
qty=0.005
```

**原因：** 风控调整后的某些订单被拆分，0.005 ETH × 3000 = 15 USDC < 20 USDC最低要求

## 🔧 需要修复的问题

### 问题1：配置未生效
**解决方案：**
1. 重新编译：`go build -o bin/phoenix cmd/runner/main.go`
2. 重启系统

### 问题2：最低订单名义价值
**现状：**
- 0.007 ETH × 3000 = 21 USDC ✅ (刚好满足20 USDC要求)
- 但风控调整后可能被拆分到0.005，导致失败

**解决方案：**
- 在`adjustQuotesForRisk`中，确保调整后的订单大小≥0.0067 (20U/3000)
- 或者直接提高`unified_layer_size`到0.0075以留有余地

### 问题3：买1卖1距离过大
**当前：** ~4.6U  
**目标：** 1-1.5U

**原因分析：**
系统还在使用旧配置的`near_layer_start_offset`和`grid_start_offset`

## 建议

### 立即执行
1. **重新编译程序**
2. **停止当前系统**
3. **重启并观察新配置是否生效**
4. **监控前30秒的挂单价格**

### 监控重点
1. ✅ 系统是否生成18层（而不是24层）
2. ✅ 订单大小是否为0.007 ETH
3. ✅ 买1距离mid是否在1-1.5U
4. ✅ 是否有"notional must be no smaller than 20"错误
5. ✅ 批量风控是否正常调整

---

**状态：** 系统运行中，但配置未完全生效  
**建议：** 重新编译并重启
