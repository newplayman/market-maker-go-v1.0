# WebSocket流量优化 - 300ms更新频率

**修改时间**: 2025-12-02  
**问题**: 3个交易对流量暴涨到2M/s  
**状态**: ✅ 已修改，待实盘测试验证

---

## 📝 修改内容

### 核心修改：降低深度更新频率

**文件**: `internal/exchange/binance_ws_real.go`

**修改前**:
```go
stream := strings.ToLower(symbol) + "@depth20@100ms"
```

**修改后**:
```go
stream := strings.ToLower(symbol) + "@depth20@300ms"
```

**关键参数**:
- ✅ **更新频率**: 100ms → 300ms（降低66.7%）
- ✅ **深度层数**: 保持20层不变
- ✅ **其他配置**: 保持不变

---

## 📊 预期效果

### 流量降低计算

**修改前（3个交易对 @100ms）**:
```
3 symbols × 10 updates/sec × 150 bytes/update = 4.5 KB/sec = 270 KB/min
高波动时可达: 2M/s
```

**修改后（3个交易对 @300ms）**:
```
3 symbols × 3.33 updates/sec × 150 bytes/update = 1.5 KB/sec = 90 KB/min
预计流量: 600-700k/s（相比2M/s降低约65-70%）
```

### 优化效果对比

| 指标 | 修改前 | 修改后 | 改善 |
|------|--------|--------|------|
| 更新频率 | 100ms | 300ms | ↓ 66.7% |
| 每秒更新次数 | 30次 | 10次 | ↓ 66.7% |
| 预计流量 | 2M/s | 600-700k/s | ↓ 65-70% |
| 深度层数 | 20层 | 20层 | 保持不变 |

---

## ✅ 验证步骤

### 1. 编译验证
```bash
cd /root/market-maker-go
go build ./...
```
✅ **结果**: 编译成功

### 2. 测试验证
```bash
go test ./internal/exchange/... -v
```
✅ **结果**: 所有测试通过

### 3. 实盘测试（待执行）

**启动程序**:
```bash
# 根据你的启动方式启动程序
./market-maker-go -config configs/phoenix_live.yaml
```

**监控指标**:
1. **网络流量监控**
   ```bash
   # 监控网络流量
   iftop -i eth0
   # 或使用
   nethogs
   ```

2. **程序日志观察**
   - 查看WebSocket连接日志
   - 确认订阅的stream格式为 `@depth20@300ms`
   - 观察是否有连接异常

3. **流量对比**
   - 记录启动后5分钟的平均流量
   - 记录10分钟后的流量峰值
   - 对比修改前的2M/s，确认是否降至600-700k/s

**预期日志**:
```
WebSocket连接成功，开始读取消息...
WebSocket压缩协商: permessage-deflate; server_no_context_takeover; client_no_context_takeover
```

---

## 🔍 监控建议

### 关键指标

1. **网络流量**
   - 目标: < 1M/s（3个交易对）
   - 告警阈值: > 1.5M/s

2. **消息处理延迟**
   - 300ms更新频率下，消息处理延迟应 < 50ms
   - 如果延迟过高，可能需要进一步优化

3. **连接稳定性**
   - 观察WebSocket重连频率
   - 正常情况下应很少重连

### 如果流量仍然过高

如果实盘测试发现流量仍然 > 1M/s，可以考虑：

1. **进一步降低更新频率**: 300ms → 500ms 或 1000ms
2. **减少深度层数**: 20层 → 10层 或 5层
3. **检查是否有其他数据流**: 确认是否订阅了其他高频数据流

---

## 📋 修改清单

- [x] 修改 `SubscribeDepth` 函数，更新频率改为300ms
- [x] 添加注释说明优化效果
- [x] 编译验证通过
- [x] 单元测试通过
- [ ] 实盘测试验证流量降低效果
- [ ] 监控流量指标，确认达到预期

---

## 📌 注意事项

1. **数据延迟**: 300ms更新频率意味着订单簿数据最多延迟300ms，对于做市策略通常可接受
2. **市场波动**: 高波动时Binance可能会推送更多更新，实际流量可能略高于预期
3. **压缩效果**: WebSocket压缩已启用，实际流量可能比计算值更低

---

## 🔄 回滚方案

如果300ms更新频率导致策略性能下降，可以快速回滚：

```go
// 回滚到100ms
stream := strings.ToLower(symbol) + "@depth20@100ms"
```

或进一步优化到500ms：
```go
stream := strings.ToLower(symbol) + "@depth20@500ms"
```

